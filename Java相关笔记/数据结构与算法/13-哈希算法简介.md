# 哈希算法简介

## 什么是哈希算法

将任意长度的二进制值串映射为固定长度的二进制值串，这个映射规则就是哈希算法，通过原始数据映射之后的二进制值串就是哈希值。

**设计一个优秀的哈希算法需要满足的几点**

* 从哈希值不能反向推导出原始数据（所以哈希算法也叫单向哈希算法）；
* 对输入数据敏感，哪怕原数据只是改动了一个Bit，最后得到的哈希值也大不相同；
* 散列冲突的概率要很小，对于不同的原始数据，哈希值相同的概率非常小；
* 哈希算法的执行效率要尽量高效，针对较长的文本，也能快速计算出哈希值。

## 常见的哈希算法

* MD4
  
* MD5（MD5 Message-Digest Algorithm，MD5 消息摘要算法）

  生成的哈希值是固定的128位二进制串。（MD5 已经号称被破解了）

* SHA（Secure Hash Algorithm，安全散列算法）

## 哈希算法的应用

哈希算法的应用非常多，常见的应用有：安全加密、唯一标识、数据校验、散列函数、负载均衡、数据分片、分布式存储。

### 安全加密

加密的目的就是防止原始数据泄漏，所以很难通过哈希值反向推导原始数据，这是一个最基本的要求。实际上，不管什么哈希算法，只能尽量减少碰撞冲突的概率，理论上是没有办法做到完全不冲突的。

**为什么哈希算法无法做到零冲突？**

分析：基于组合数学中一个非常基础的理论，鸽巢原理（也叫抽屉原理）。这个原理本身很简单，它是说，如果有 10 个鸽巢，有 11 只鸽子，那肯定有 1 个鸽巢中的鸽子数量多于 1 个，换句话说就是，肯定有 2 只鸽子在 1 个鸽巢内。

哈希算法产生的哈希值的长度是固定且有限的。比如MD5算法，MD5最多只能产生$2^128$个哈希值，那么对于$2^128$ + 1个数据求哈希值，肯定会出现至少一个冲突的。

除此之外，没有绝对安全的加密。越复杂、越难破解的加密算法，需要的计算时间也越长。比如 SHA-256 比 SHA-1 要更复杂、更安全，相应的计算时间就会比较长。密码学界也一直致力于找到一种快速并且很难被破解的哈希算法。我们在实际的开发过程中，也需要权衡破解难度和计算时间，来决定究竟使用哪种加密算法。

### 唯一标识

哈希算法还可以用于生成数据的唯一标识，用于快速查找数据。

举例说明：如果要在海量图库中，检索一个图片是否存在，不能单纯地用图片的元信息（比如图片名称）来比对，因为有可能存在名称相同但图片内容不同，或者名称不同图片内容相同的情况。

可以先给每一个图片取一个唯一标识，或者说信息摘要。比如，可以从图片的二进制码串开头取 100 个字节，从中间取 100 个字节，从最后再取 100 个字节，然后将这 300 个字节放到一块，通过哈希算法（比如 MD5），得到一个哈希字符串，用它作为图片的唯一标识。通过这个唯一标识来判定图片是否在图库中，这样就可以减少很多工作量。

如果还想继续提高效率，可以把每个图片的唯一标识，和相应的图片文件在图库中的路径信息，都存储在散列表中。当要查看某个图片是不是在图库中的时候，我们先通过哈希算法对这个图片取唯一标识，然后在散列表中查找是否存在这个唯一标识。

如果不存在，那就说明这个图片不在图库中；如果存在，我们再通过散列表中存储的文件路径，获取到这个已经存在的图片，跟现在要插入的图片做全量的比对，看是否完全一样。如果一样，就说明已经存在；如果不一样，说明两张图片尽管唯一标识相同，但是并不是相同的图片。

### 数据校验

哈希算法可以给数据生成哈希值，用于校验数据是否被修改过。

对于BT下载软件一类的，它们使用的下载方式一般是将文件分成多个小文件块，并行下载，下载完成后再合并成一个完整的大文件。

因为网络传输是不安全的，下载的文件块可能被宿主机器恶意修改过，又或者下载过程中出现了错误，所以下载的文件可能是不安全或不完整的。

如何来校验文件块的安全、正确、完整呢？

具体的 BT 协议很复杂，校验方法也有很多。其中的一种思路是通过哈希算法，对于多个文件块分布取哈希值，并且保存到种子文件中。哈希算法有一个特点，对数据很敏感。只要文件块的内容有一丁点儿的改变，最后计算出的哈希值就会完全不同。所以，当文件块下载完成之后，可以通过相同的哈希算法，对下载好的文件块逐一求哈希值，然后跟种子文件中保存的哈希值比对。如果不同，说明这个文件块不完整或者被篡改了，需要再重新从其他宿主机器上下载这个文件块。

### 散列函数

对于散列表中的散列函数也是哈希算法的一种应用。

不过相对于哈希算法的其他应用，散列函数对于哈希算法要求低很多。即便出现个别散列冲突，只要不是过于严重，也可以通过开放寻址法或者链表法解决。散列函数对于散列算法计算得到的值，是否能反向解密也不关心。散列函数中用到的散列算法，更加关注散列后的值是否能平均分布，也就是，一组数据是否能均匀地散列在各个槽中。除此之外，散列函数执行的快慢，也会影响散列表的性能，所以，散列函数用的散列算法一般都比较简单，比较追求效率。

### 负载均衡

负载均衡有很多算法，比如轮询、随机、加权随机等。如何实现一个会话粘滞（session sticky）的负载均衡算法？

可以通过哈希算法，对客户端 IP 地址或者会话 ID 计算哈希值，将取得的哈希值与服务器列表的大小进行取模运算，最终得到的值就是应该被路由到的服务器编号。这样，就可以把同一个ip过来的所有请求，都路由到同一个后端服务器上。

### 数据分片

感觉和分布式存储有一定关系，就是通过对数据取哈希值，快速判断数据放在哪个机器上或数据不存在。

### 分布式存储

对于大量的数据，为了提高数据的读取、写入能力，一般都采用分布式的方式存储数据，比如分布式缓存。

如何确定将哪个数据放到哪台机器上？可以通过哈希算法对数据取哈希值，然后对机器个数取模，这个最终值就是数据要放的机器号上。

但是这个方式有弊端，当对服务器进行扩容或者紧缩，上面确定数据放到哪个机器上面的方式就会有问题，导致之前所有的存储都失效了，造成缓冲雪崩。可以使用一致性哈希算法来确定数据存储到哪个机器上。

## 问题

* 如何存储用户的密码

  可以通过哈希算法，对用户密码进行加密之后再存储，不过最好选择相对安全的加密算法，比如 SHA 等（因为 MD5 已经号称被破解了）。但是这样并不一定是最安全的，为了防止字典攻击，可以引入一个盐（salt），跟用户密码组合在一起，增加密码的复杂度。拿组合之后的字符串来做哈希算法加密，将它存储到数据库中，进一步增加破解的难度。**安全和攻击是一种博弈关系，不存在绝对的安全。所有的安全措施，只是增加攻击的成本而已。**

* 区块链使用的是哪种哈希算法吗？是为了解决什么问题而使用的呢？

* [一致性哈希算法](http://www.zsythink.net/archives/1182#comment-2643)