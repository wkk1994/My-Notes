# CAP原则

## 分区容错(Partition tolerance)

大多数分布式系统都分布在多个子网络中。每个子网络叫做一个区（patition）。这些子网络本来是应该连通的，然后可能因为一些故障，使得有些节点之间不连通了，整个网络分成几块区域。数据就散布在不连通的区域，这就叫做分区。

这个时候位于两个不同的区的应用就不能进行通信，这时分区就无法容忍。

提高分区容错的的方法就是部署多个应用，那么出现分区之后，应用还能通信，容忍性就提高了。

但是对于有状态的应用来说，比如数据库，消息中间件等，各个节点的数据需要进行复制，保持一致，那么就会带来数据一致性问题。要保证一致性，每次写操作都要等待全部节点写成功，而等待又会带来可用性问题。总的来说就是，数据存在的节点越多，分区容忍性越高，但要复制更新的数据就越多，一致性就越难保证。为了保证一致性，更新所有节点数据所需要的时间就越长，可用性就会降低。

因为网络通信是无法保障的，所以一般来说分区容错是无法避免的，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们，剩下的 C 和 A 无法同时做到。

## 一致性(Consistency)

一致性是指所有节点的同一时间的数据是完全一致的，也就是一个写操作之后，其他节点也能立马读到写之后的值。

对于多节点来说，要保证一致性就需要将一个写操作复制到其他节点后才能允许读操作，这样势必会影响可用性。

### 一致性的分类

* 强一致性

  对于关系型数据库，要求更新过的数据能被后续的访问都能看到，这是强一致性。

* 弱一致性

  能够容忍更新后的数据，部分节点访问不到，则是弱一致性。

* 最终一致性

  经过一段时间后要求能访问到更新后的数据，则是最终一致性。

## 可用性(Availability)

可用性是指服务一致可用，收到请求就能正常响应。

## Consistency 和 Availability 的矛盾

因为分区容错是无法避免的，所以一般的CAP中都是需要权衡AC。

为什么一致性和可用性不能同时存在？

假设存在节点A1，A2两个节点，如果要保证A1，A2数据的一致性，那么就必须在A1进行写操作的时候，锁定A2的读操作。只有在数据同步后，A2才能重新开发读写。锁定期间A2不能读写，没有可用性了。如果要保证A2的可用性，那么势必不能锁定A2，所以一致性就不成立了。

## 三二原则

对于分布式系统来说，在CAP原则中分区容错P是必须保证的，但其不能同时保证一致性和可用性，因为现在的分布式系统在满足一致性的前提下，会牺牲可用性，在满足了可用性的前提下，会牺牲一致性，所以CAP原则对于一个分布式系统来说，只可能满足两项，要么CP，要么AP，这就是CAP的三二原则。

## Zookeeper和Eureka的区别

**Zookeeper能保证CP**，为什么？

在Zookeeper运行期间，如果Leader节点挂了，那么整个Zookeeper集群将暂停对外服务，进入新一轮Leader选举。问题在于，选举Leader的时间太长，30s～120s，在这个选举期间整个Zookeeper集群都不可用，这就会导致选举期间注册服务瘫痪。所以可以看出，Zookeeper保证一致性和分区容错性，不保证可用性。

**Eureka保证的是AP**。

Eureka的各个节点都是平等的，几个节点挂掉不会影响正常节点的工作，剩余节点依然可以提供注册和查询服务。而Eureka的客户端在向某个Eureka注册或时如果发现连接失败，则会自动切换至其它节点，只要有一台Eureka还在，就能保证注册服务可用(保证可用性)，只不过查到的信息可能不是最新的(不保证强一致性)。除此之外，Eureka还有一种自我保护机制，如果在15分钟内超过85%的节点都没有正常的心跳，那么Eureka就认为客户端与注册中心出现了网络故障，此时会出现以下几种情况：

1. Eureka不再从注册列表中移除因为长时间没收到心跳而应该过期的服务
2. Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其它节点上(即保证当前节点依然可用) 。
3. 当网络稳定时，当前实例新的注册信息会被同步到其它节点中。

因此， Eureka可以很好的应对因网络故障导致部分节点失去联系的情况，而不会像zookeeper那样使整个注册服务瘫痪。

## 参考

* [zk和eureka的区别（CAP原则）](https://www.cnblogs.com/chihirotan/p/11366394.html)
* [CAP理论中的P到底是个什么意思？](https://www.zhihu.com/question/54105974)