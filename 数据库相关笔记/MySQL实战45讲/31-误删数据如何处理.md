# 误删数据如何处理

MySQL误删数据的操作：
* 使用delete语句误删数据行；
* 使用drop table或者truncate table语句误删数据表；
* 使用drop database语句误删数据库；
* 使用rm命令误删整个MySQL实例。

## 误删行数据

误删行数据可以通过使用Flashback工具通过闪回把数据恢复回来。

Flashback 恢复数据的原理，是修改 binlog 的内容，拿回原库重放。而能够使用这个方案的前提是，需要确保 binlog_format=row 和 binlog_row_image=FULL。

**不建议直接在主库上执行这些操作**，恢复数据比较安全的做法是恢复一个备份，或者找一个从库作为临时库，在这个临时库上执行这些操作，然后再将确认过的临时库的数据，恢复回主库。

**怎么避免误删除行数据**

1.参数`sql_safe_updates`设置为no，如果在delete或者update中没有where条件，或者where条件里面没有包含索引字段的话，这条语句的执行就会报错。
2.代码上线前，必须经过 SQL 审计。

## 误删库/表

### 全量备份

这种情况下不能通过Flashback恢复数据了，就需要使用全量备份，加增量日志的方式。这个方案要求线上要有定期的全量备份，并且实时备份binlog。

恢复数据的流程如下：
1.取最近一次全量备份，假设这个库是一天一备，上次备份是当天 0 点；
2.用备份恢复出一个临时库；
3.从日志备份里面，取出凌晨 0 点之后的日志；
4.把这些日志，除了误删除数据的语句外，全部应用到临时库。

说明：

* 为了加速数据恢复，可以说在使用mysqlbinlog时，加上-database参数，指定误删表/库所在的库。
* 在应用日志时，如何跳过误删除语句的那个binlog：
    * 如果原实例没有使用GTID模式，只能在应用到包含误删除语句的binlog的时候，先用-stop-position参数执行误操作之前的日志，再用-start-position从误操作之后的日志继续执行；
    * 如果实例使用了GTID模式，只需要执行一个set gtid_next=gtid1（误删除数据的gtid）;begin;commit;先把这个GTID加到临时实例的GTID集合，之后按顺序执行binlog的时候，就会自动跳过误操作的语句。

使用 mysqlbinlog 方法恢复数据还是不够快，主要原因有两个：
1.如果是误删表，最好就是只恢复出这张表，也就是只重放这张表的操作，但是 mysqlbinlog 工具并不能指定只解析一个表的日志；
2.用 mysqlbinlog 解析出日志应用，应用日志的过程就只能是单线程。

**加速的方法**

* 在用备份恢复出临时实例之后，将这个临时实例设置成线上备库的从库，在start slave之前，先通过执行change replication filter replicate_do_table = (tbl_name) 命令，就可以让临时库只同步误操作的表；这样做也可以用上并行复制技术，来加速整个数据恢复过程。

### 延迟复制备库

搭建延迟复制的备库，这个功能在MySQL5.6版本引入的。延迟复制的备库是一种特殊的备库，通过 CHANGE MASTER TO MASTER_DELAY = N 命令，可以指定这个备库持续保持跟主库有 N 秒的延迟。这样及时发现问题后，问题还没有传播到延迟备库上，在延迟备库上跳过错误操作，就可以恢复出需要的数据。

**预防误删库 / 表的方法**

* 账号分离。这样做的目的是，避免写错命令。
    * 只给业务开发同学 DML 权限，而不给 truncate/drop 权限。而如果业务开发人员有 DDL 需求的话，也可以通过开发管理系统得到支持。
    * 即使是 DBA 团队成员，日常也都规定只使用只读账号，必要的时候才使用有更新权限的账号。
* 制定操作规范。这样做的目的，是避免写错要删除的表名。
    * 在删除数据表之前，必须先对表做改名操作。然后，观察一段时间，确保对业务无影响以后再删除这张表。
    * 改表名的时候，要求给表名加固定的后缀（比如加 _to_be_deleted)，然后删除表的动作必须通过管理系统执行。并且，管理系删除表的时候，只能删除固定后缀的表。

## rm 删除数据

对于一个有高可用机制的 MySQL 集群来说，最不怕的就是 rm 删除数据。只要不是恶意地把整个集群删除，而只是删掉了其中某一个节点的数据的话，HA 系统就会开始工作，选出一个新的主库，从而保证整个集群的正常工作。然后再手动在这个节点上把数据恢复回来，再接入整个集群。

## 恢复binlog日志

当在恢复数据时，如果需要回放的binlog已经被备份了，在MySQL日志中时，可以将binlog日志文件复制回MySQL日志中。操作步骤为：

* 从备份系统下载 master.000005 和 master.000006 这两个文件，放到备库的日志目录下；
* 打开日志目录下的 master.index 文件，在文件开头加入两行，内容分别是 “./master.000005”和“./master.000006”;
* 重启备库，目的是要让备库重新识别这两个日志文件；
* 现在这个备库上就有了临时库需要的所有 binlog 了，建立主备关系，就可以正常同步了。
