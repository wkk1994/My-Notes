# 第 14 课 超越分库分表-高可用与读写分离

## 1.从单机到集群

### 单机MySQL数据库的几个问题

随着数据量的增大，读写并发的增加，系统可用性要求的提升，单机MySQL面临：

1、容量有限，难以扩容
2、读写压力，QPS过大，特别是分析类需求会影响到业务事务
3、可用性不足，宕机问题

> 理论知识：一般的机器MySQL的TPS不要超过6千，QPS不要大于几万。超过这个值可能就有性能问题。
> **注意读写比**，如果读写比比较高的情况下，适合使用缓存技术，将数据缓存，不走数据库。

### 单机MySQL的技术演进

读写压力 --> 多机集群 --> 主从复制
高可用性 --> 故障转移 --> MHA/MGR/Orachestrator
容量问题 --> 数据库拆分 --> 分库分表：垂直拆分、水平拆分
一致性问题 --> 分布式事务 --> XA/柔性事务

> 为了解决一部分问题会带来新的问题，引入集群等方式就会带来一致性问题。
> XA事务太慢，可以使用柔性事务（通过业务代码实现分布式事务）。

## 2.MySQL主从复制

### 主从复制原理

核心是：主库写binlog，从库relay log。

![主从复制原理.png](https://note.youdao.com/yws/api/personal/file/WEBdb8083bcf2c4ec83c3d1da3824c1e295?method=download&shareKey=22e3d856d336d006cf923c29b3a1e61c)

* 2000年，MySQL 3.23.15版本引入了复制
* 2002年，MySQL 4.0.2版本分离IO和SQL线程，引入了relay log
* 2010年，MySQL 5.5版本引入半同步复制
* 2016年，MySQL在5.7.17中引入InnoDB Group Replication

binlog格式: row、statement、mixed。版本<=5.7.6默认格式是statement，>=5.7.7默认是row。

> mysql自带的`mysqlbinlog`可以用来查看binllog日志。

#### 异步复制

传统主从复制--2000年，MySQL3.23.15版本引入了Replication。

网络或机器故障会造成数据不一致。

![传统主从复制.png](https://note.youdao.com/yws/api/personal/file/WEB1b15574f1239f91e2b6d23ad100432fa?method=download&shareKey=a0b6a8503166ce1e4031d0714a0f0866)

#### 半同步复制

需要启用插件。主库上的事务至少要在一个从库上执行成功才能提交（所需从库的数量是可配置的）。这样就能保证至少有一个从库和主库一致。保证source和replica最终一致性。

> 如果在没有任何从库确认事务的情况下发生超时，则主库将恢复为异步复制。赶上至少一个半同步从库时，主库将返回到半同步复制。
> rpl_semi_sync_master_wait_for_slave_count 每个事务必须接收的副本确认的数量，该 系统变量的默认值为1。

![半同步复制.png](https://note.youdao.com/yws/api/personal/file/WEB44f81286b2fba9278bed81433669d6aa?method=download&shareKey=60a71629952290873618c8aa5f2a79dc)

#### 组复制（MGR）

基于分布式Paxos协议实现组复制，保证数据一致性。

![组复制（MGR）](https://note.youdao.com/yws/api/personal/file/WEB056d6c42f232411b2441db5181fb9346?method=download&shareKey=ceb3d6a07a66f65bb748a5ae6a411e95)

### 主从复制的局限性

* 主从延迟问题：所有的主从复制数据量大了都会产生这个问题。
* 应用侧需要配合读写分离框架：应用连接数据库的时候没办法知道哪个是主库哪个从库，需要修改代码实现读写分离。
* 不解决高可用问题：异步复制和半同步复制都不能解决高可用问题。组复制内部实现了高可用，也可以通过其他中间件解决高可用问题。

## 3.MySQL读写分离

### 读写分离-动态切换数据源版本1.0

* 基于Spring/Spring Boot，配置多个数据源（例如2个，master和slave）。
* 根据具体的Service方法是否会操作数据，注入不同的数据源。
* 改进点1:基于操作AbstractRoutingDataSource和自定义注解readOnly之类 的，简化自动切换数据源。
* 改进点2:支持配置多个从库。
* 改进点3:支持多个从库的负载均衡。

### 读写分离-数据库框架版本2.0

* 上面的方式对代码的侵入性还是较强。
* 可以通过ShardingSphere-jdbc的Master-Slave功能。实现：
  * SQL解析和事务管理，自动实现读写分离
  * 解决”写完读”不一致的问题

### 读写分离-数据库中间件版本3.0

上面的数据库架构版本还是对系统有一定的侵入，并且对旧系统不友好。
改进方式：通过中间件配置读写的规则，这个中间件模拟了一个MySQL服务器，对业务系统无侵入。

常见的中间件：MyCat/ShardingSphere-Proxy的Master-Slave功能。

## 4.MySQL高可用(HA)

### 高可用的定义

更少的不可用时间，一般使用SLA/SLO衡量。

1年 = 365天 = 8760小时
99 = 8760 * 1% = 8760 * 0.01 = 87.6小时
99.9 = 8760 * 0.1% = 8760 * 0.001 = 8.76小时
99.99 = 8760 * 0.0001 = 0.876小时 = 0.876 * 60 = 52.6分钟
99.999 = 8760 * 0.00001 = 0.0876小时 = 0.0876 * 60 = 5.26分钟

> 业内对于99.99也是很难做到，一般会将主动停机的时间不计算在内。

**SLA、SLO 和 SLI的区别**

* SLA：服务水平协议

> 公有云在高并发下的使用情况并不是稳定的。
> 99.95%是几个9？3 - log(10)5, 1-99.95取对数再取负
> [可用性计算参考](https://en.wikipedia.org/wiki/High_availability)
> 我的理解是通过不可用性进行比较99.95%到99.99%，不可用性从0.05%到0.01%，这个提升不是2的倍数，所以不能认为99.95%是3.5个9。

### 为什么要高可用

* 读写分离：提升读的处理能力，将读的压力分散到从库中，这样主库写的性能自然就上来了。
* 故障转移：提供failover能力，如果主库宕机，选择从库提升为主库。

加上业务侧连接池的心跳重试，实现断线重连，业务不间断，降低 RTO 和 RPO。

> **RTO(Recovery Time Objective，复原时间目标)**: 故障后需要恢复到正常业务状态的时间。
> **RPO(Recovery Point Objective，复原点目标)**: 丢失的数据到最近一次数据备份对应的时间。

什么是failover，故障转移，灾难恢复。

容灾：热备与冷备

> 热备和冷备：备份的机器提供服务为热备，只有在故障转移才提供服务为冷备。
> 银行机构有宕机要求，不能超过40分钟

故障转移常见的一些策略：

* 多个实例不在一个主机/机架上，避免整个主机或机架导致的实例全部宕机。
* 跨机房和可用区部署
* 两地三中心容灾高可用方案：2个本地同城的灾备中心，3个异地灾备中心。异地要求是800公里。一般不会那么符合要求。

### MySQL高可用0：主从手动切换

如果主节点挂掉，将某个从节点改为主节点；重新配置其他从节点，修改应用的配置信息。

这样操作的问题：可能数据不一致；需要人工干预；代码和配置的侵入性。

### MySQL高可用1：主从手动切换

使用LVS + Keepalived实现多个节点的探活 + 请求路由。配置VIP或DNS实现配置不变更。

问题：也是需要手工处理主从切换；大量的配置和脚本定义。

### MySQL高可用2：MHA

MHA（Master High Availability）目前在 MySQL 高可用方面是一个相对成熟的解决 方案，它由日本 DeNA 公司的 youshimaton（现就职于 Facebook 公司）开发，是一套优秀的作为 MySQL 高可用性环境下故障切换和主从提升的高可用软件。

基于Perl语言开发，一般能在30s内实现主从切换。 切换时，直接通过SSH复制主节点的日志。

问题：需要配置SSH信息，至少3台。

### MySQL高可用3：MGR

如果主节点挂掉，将自动选择某个从改成主；无需人工干预，基于组复制，保证数据一致性。

实现机制：MGR会将主从信息保存到一个表中，通过读取这个表就可以获取到当前的集群的主从信息，当数据库集群变更时，会同步修改这个表，外部再读取这个表信息就能获取到变更后的主从信息。

问题：外部获得状态变更需要读取数据库；外部需要使用LVS/VIP配置。

**MGR特征**

* 高一致性：基于分布式Paxos协议实现组复制，保证数据的一致性；
* 高容错性：自动检测机制，只要不是大多数节点都宕机就可以继续工作，内置防脑裂保护机制；
* 高扩展性：节点曾加与移除都会自动更新组信息，新节点加入后，自动从其他节点同步增量数据，直到与其他节点数据一致；
* 高灵活性：提供单主模式和多主模式，单主模式在主库宕机后能够自动选主，所有写入都在主节点进行，多模式支持多节点写入。

### MySQL高可用4：MySQL Cluster

完整的数据库层高可用解决方案

MySQL InnoDB Cluster是一个高可用架构，由下面几个组件构成：

* MySQL Group Replication：提供DB扩展、自动故障迁移。
* MySQL Router：轻量级中间件，提供应用程序连接目标的故障转移。
* MySQL Shell：新的MySQL客户端，多种接口模式。可以设置组复制以及Router。

### MySQL高可用5：Orchestrator

/哦gai死zuai特/

一款MySQL高可用和复制拓扑管理工具，支持复制拓扑结构的调整，自动故障转移和手动主从切换等。基于Go语言开发，实现了中间件本身的高可用。后端数据库用MySQL或SQLite存储元数据，并提供Web界面展示MySQL复制的拓扑关系及状态，通过Web可更改MySQL实例的复制关系和部分配置信息，同时也提供了命令行和API接口，方便运维管理。

特点：

* 自动发现MySQL复制拓扑，并在Web上展示；
* 重构复制关系，可以在Web进行拖图来进行复制关系的变更；
* 检查主异常，并可以手动或自动恢复，同Hooks进行自定义脚本；
* 支持命令行和Web界面管理复制。

## 5.总结回顾与作业实践

## Tips

* 金融行业的典型交易系统：银行、证券和保险。交易所属于证券。
* 阿里双十一58.3万TPS
* 一般单机的应用TPS不要超过6千
* 同构：第一个意思是数据库相同，比如都是mysql，第二个意思是表结构相同
* 异构：和同构的意思相反。
* 京东内部只有白条使用sharding，其他使用CDS
* dubbo ssf
* JSF就是dubbo，京东内部的RPC框架，就是在dubbo上添加了admin的管理页面。
* DMZ
* 量子计算机不能解决通用性的计算问题
* OSS
* RDMA PM
* DFS:分布式的磁盘
* create table t1 like t2;
* create schema testdb;
* catalog, schema,database: 一个数据库系统包含多个catalog，每个catalog包含多个schema，每个schema包含多个database数据库对象（表、视图、字段等）。不同的数据库对catalog、schema的支持和实现不同，mysql默认所有的schema都和database名称一致，catalog写死都是def。[参考](https://www.php.cn/mysql-tutorials-129761.html)
* show plugins查询mysql的插件

## 问题

* Paxos协议是什么
